# Maven Plugin for Azure

## Table of Content
  - [Overview](#overview)
    - [AzureMaven Plugin](#azure-login-overview)
  - [Prerequisites](#prerequisites)
  - [Goals](#goals)
    - [`azure:login`](#azure-login)
    - [`azure:select-subscription`](#azure-select-subscription)
    - [`azure:logout`](#azure-logout)

## Overview

<a name="azure-login-overview"></a>
### Azure Maven plugin
Azure Maven plugin provides basic functions for all Azure maven plugins, eg: login. Please refer to [Login](#azure-login) section for details.


<a name="prerequisites"></a>
## Prerequisites
Tool | Required Version
---|---
JDK | 1.8 
Maven | 3.x.x

<a name="goals"></a>
## Goals

<a name="azure-login"></a>
### azure:login

-  A plugin goal providing a login experience for access azure resources. It will detect whether a browser is available and open the browser or print a device-login url/code, you can continue the sign-in process through the browser or device-login url. After login, it is strongly recommended to set the default subscription through the `azure:select-subscription` goal if you have multiple subscriptions, otherwise the first subscription will be taken as the default subscription. After you login success, an [authentication refresh token](https://docs.microsoft.com/en-us/azure/active-directory/develop/v1-id-and-access-tokens#refresh-tokens)
is generated by Azure and stored at `$HOME/.azure/azure-login.json`, please protect that file. It will never expire, but this credential can be revoked by your tenant administrator, see [Revoke-AzureADUserAllRefreshToken](https://docs.microsoft.com/en-us/powershell/module/azuread/revoke-azureaduserallrefreshtoken?view=azureadps-2.0) for details. Once the token is revoked, you will get a message from the CLI saying you need to sign in again. 

> Note: <br> - The refresh_token saved will never expire util it is revoked, the access token will be updated using refresh_token if it is expired.
> <br> - For multiple module case, execute this goal in parent folder will only execute once, you need to declare *azure-maven-plugin* in parent pom files in ***\<build>\<plugins>** or **\<build>\<pluginManagement>\<plugins>** sections, if you don't want to do so, you can execute `mvn com.microsoft.azure:azure-maven-plugin:0.1.0-SNAPSHOT:login`
> <br> - If you don't proceed with the login in the browser after 5 minutes, this goal will fail.
> <br> - If you want to use device login directly, you can run `mvn azure:login -Ddevicelogin`
> <br> - If you execute `azure:login` for a second time, plugin will remove the previous  [authentication refresh tokens](https://docs.microsoft.com/en-us/azure/active-directory/develop/v1-id-and-access-tokens#refresh-tokens) if you sign in successfully, the default subscription will not change if it still exists in current account, otherwise the default subscription will be removed.

<a name="azure-select-subscription"></a>
### azure:select-subscription

-  A plugin goal providing an ability to set the active subscription, if you use service principal, or your account have only one subscription, you may ignore this goal. Otherwise you might need to specify the active subscription. If you run `azure:select-subscription` without specifying the *subscription* argument, all selectable subscriptions will be listed(with a *star* mark on the current active subscription), you can then set the active subscription by the *index* value before subscription, or press `ctrl+c` to escape if you just want to get the current active subscription.
```bash
mvn azure:select-subscription
mvn azure:select-subscription -Dsubscription=<put your subscription guid or name here>
```

<a name="azure-logout"></a>
### azure:logout
- This goal will remove all [authentication refresh tokens](https://docs.microsoft.com/en-us/azure/active-directory/develop/v1-id-and-access-tokens#refresh-tokens) from your machine, the current active subscription will also be removed, so next time you need to specify active subscription again after `azure:login`.
 
 > Note: <br> - The active subscription saved at `$HOME/azure-secret.json` will be deleted by execute goal *azure:logout*.